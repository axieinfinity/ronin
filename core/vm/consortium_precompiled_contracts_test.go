package vm

import (
	"bytes"
	"fmt"
	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/common/math"
	"github.com/ethereum/go-ethereum/core/rawdb"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/crypto"
	"github.com/ethereum/go-ethereum/params"
	"math/big"
	"strings"
	"testing"
)

/*
*
testSortCodes is generated based on the following code
```
// SPDX-License-Identifier: GPL-3.0

pragma solidity >=0.8.0 <0.9.0;

	contract Validators {
	    address[] _validators = [
	    0x0000000000000000000000000000000000000010,
	    0x0000000000000000000000000000000000000011,
	    0x0000000000000000000000000000000000000012,
	    0x0000000000000000000000000000000000000013,
	    0x0000000000000000000000000000000000000014,
	    0x0000000000000000000000000000000000000015,
	    0x0000000000000000000000000000000000000016,
	    0x0000000000000000000000000000000000000017,
	    0x0000000000000000000000000000000000000018,
	    0x0000000000000000000000000000000000000019,
	    0x0000000000000000000000000000000000000020,
	    0x0000000000000000000000000000000000000021,
	    0x0000000000000000000000000000000000000022,
	    0x0000000000000000000000000000000000000023,
	    0x0000000000000000000000000000000000000024,
	    0x0000000000000000000000000000000000000025,
	    0x0000000000000000000000000000000000000026,
	    0x0000000000000000000000000000000000000027,
	    0x0000000000000000000000000000000000000028,
	    0x0000000000000000000000000000000000000029,
	    0x0000000000000000000000000000000000000030
	    ];
	    uint256[] _totalBalances = [1,4,6,2,8,9,10,3,16,20,100,12,22,30,50,60,5,18,16,22,21];
		constructor() {}
	    function getValidatorCandidates() public view returns (address[] memory _validatorList) {
	        _validatorList = _validators;
	    }
	    function totalBalances(address[] calldata _poolList) public view returns (uint256[] memory _balances) {
	        _balances = _totalBalances;
	    }
	}

```
*/
const testSortCode = `6080604052604051806102a00160405280601073ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001601173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001601273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001601373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001601473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001601573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001601673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001601773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001601873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001601973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001602073ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001602173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001602273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001602373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001602473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001602573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001602673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001602773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001602873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001602973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001603073ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815250600090601561044d92919061054d565b50604051806102a00160405280600160ff168152602001600460ff168152602001600660ff168152602001600260ff168152602001600860ff168152602001600960ff168152602001600a60ff168152602001600360ff168152602001601060ff168152602001601460ff168152602001606460ff168152602001600c60ff168152602001601660ff168152602001601e60ff168152602001603260ff168152602001603c60ff168152602001600560ff168152602001601260ff168152602001601060ff168152602001601660ff168152602001601560ff16815250600190601561053a9291906105d7565b5034801561054757600080fd5b50610646565b8280548282559060005260206000209081019282156105c6579160200282015b828111156105c55782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055509160200191906001019061056d565b5b5090506105d39190610629565b5090565b828054828255906000526020600020908101928215610618579160200282015b82811115610617578251829060ff169055916020019190600101906105f7565b5b5090506106259190610629565b5090565b5b8082111561064257600081600090555060010161062a565b5090565b610460806106556000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c80634a5d76cd1461003b578063ba77b06c1461006b575b600080fd5b610055600480360381019061005091906101e1565b610089565b60405161006291906102f6565b60405180910390f35b6100736100e4565b6040516100809190610408565b60405180910390f35b606060018054806020026020016040519081016040528092919081815260200182805480156100d757602002820191906000526020600020905b8154815260200190600101908083116100c3575b5050505050905092915050565b6060600080548060200260200160405190810160405280929190818152602001828054801561016857602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001906001019080831161011e575b5050505050905090565b600080fd5b600080fd5b600080fd5b600080fd5b600080fd5b60008083601f8401126101a1576101a061017c565b5b8235905067ffffffffffffffff8111156101be576101bd610181565b5b6020830191508360208202830111156101da576101d9610186565b5b9250929050565b600080602083850312156101f8576101f7610172565b5b600083013567ffffffffffffffff81111561021657610215610177565b5b6102228582860161018b565b92509250509250929050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b6000819050919050565b61026d8161025a565b82525050565b600061027f8383610264565b60208301905092915050565b6000602082019050919050565b60006102a38261022e565b6102ad8185610239565b93506102b88361024a565b8060005b838110156102e95781516102d08882610273565b97506102db8361028b565b9250506001810190506102bc565b5085935050505092915050565b600060208201905081810360008301526103108184610298565b905092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061036f82610344565b9050919050565b61037f81610364565b82525050565b60006103918383610376565b60208301905092915050565b6000602082019050919050565b60006103b582610318565b6103bf8185610323565b93506103ca83610334565b8060005b838110156103fb5781516103e28882610385565b97506103ed8361039d565b9250506001810190506103ce565b5085935050505092915050565b6000602082019050818103600083015261042281846103aa565b90509291505056fea26469706673582212204aab6725297603e4a73daf57fffdd55330e60293dfde78dcbbddb9178144583064736f6c63430008110033`

/*
*
wrapupCode is used to call sortValidators precompiled contract with the following code
```
// SPDX-License-Identifier: GPL-3.0
pragma solidity >=0.8.0 <0.9.0;

	contract Wrapup {
	    constructor() {}

	    address[] _validators = [
	        0x0000000000000000000000000000000000000064,
	        0x0000000000000000000000000000000000000065,
	        0x0000000000000000000000000000000000000066,
	        0x0000000000000000000000000000000000000067,
	        0x0000000000000000000000000000000000000068,
	        0x0000000000000000000000000000000000000069,
	        0x000000000000000000000000000000000000006a,
	        0x000000000000000000000000000000000000006b,
	        0x000000000000000000000000000000000000006C,
	        0x000000000000000000000000000000000000006D,
	        0x000000000000000000000000000000000000006E,
	        0x000000000000000000000000000000000000006F,
	        0x0000000000000000000000000000000000000070,
	        0x0000000000000000000000000000000000000071,
	        0x0000000000000000000000000000000000000072,
	        0x0000000000000000000000000000000000000073,
	        0x0000000000000000000000000000000000000074,
	        0x0000000000000000000000000000000000000075,
	        0x0000000000000000000000000000000000000076,
	        0x0000000000000000000000000000000000000077,
	        0x0000000000000000000000000000000000000078
	    ];
	    uint256[] _weights = [
	        uint256(1000),
	        uint256(2000),
	        uint256(3000),
	        uint256(4000),
	        uint256(5000),
	        uint256(6000),
	        uint256(7000),
	        uint256(8000),
	        uint256(9000),
	        uint256(10000),
	        uint256(11000),
	        uint256(12000),
	        uint256(13000),
	        uint256(14000),
	        uint256(15000),
	        uint256(16000),
	        uint256(17000),
	        uint256(18000),
	        uint256(19000),
	        uint256(20000),
	        uint256(21000)
	    ];

	    function sortValidators() public view returns (address[3] memory _result) {
	        bytes memory payload = abi.encodeWithSignature(
	            "sortValidators(address[],uint256[])",
	            _validators,
	            _weights
	        );

	        uint256 payloadLength = payload.length;
	        uint256 validatorsLength = _validators.length;
	        uint256 validatorsLengthHex = validatorsLength * 0x20;
	        uint256 validatorsLengthHex64 = validatorsLength * 0x20 + 64;
	        address _smc = address(0x66);

	        assembly {
	            let payloadStart := add(payload, 32)
	            if iszero(
	                staticcall(
	                    0,
	                    _smc,
	                    payloadStart,
	                    payloadLength,
	                    _result,
	                    validatorsLengthHex64
	                )
	            ) {
	                revert(0, 0)
	            }
	            returndatacopy(_result, 64, validatorsLengthHex)
	            return(_result, validatorsLengthHex)
	        }
	    }
	}

```
*/
const (
	wrapupCode = `6080604052604051806102a00160405280606473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606c73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606d73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606e73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606f73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607073ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815250600090601561044d929190610523565b50604051806102a001604052806103e881526020016107d08152602001610bb88152602001610fa0815260200161138881526020016117708152602001611b588152602001611f40815260200161232881526020016127108152602001612af88152602001612ee081526020016132c881526020016136b08152602001613a988152602001613e80815260200161426881526020016146508152602001614a388152602001614e20815260200161520881525060019060156105109291906105ad565b5034801561051d57600080fd5b50610617565b82805482825590600052602060002090810192821561059c579160200282015b8281111561059b5782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555091602001919060010190610543565b5b5090506105a991906105fa565b5090565b8280548282559060005260206000209081019282156105e9579160200282015b828111156105e85782518255916020019190600101906105cd565b5b5090506105f691906105fa565b5090565b5b808211156106135760008160009055506001016105fb565b5090565b6105bc806106266000396000f3fe608060405234801561001057600080fd5b506004361061002b5760003560e01c806327167aec14610030575b600080fd5b61003861004e565b60405161004591906102de565b60405180910390f35b61005661014c565b600080600160405160240161006c9291906102fa565b6040516020818303038152906040527f788341af000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050905060008151905060008080549050905060006020826101099190610430565b90506000604060208461011c9190610430565b61012691906103da565b90506000606690506020860182888783856000fa61014357600080fd5b836040893e8388f35b604051806102a00160405280601590602082028036833780820191505090505090565b600061017b838361019f565b60208301905092915050565b600061019383836102cf565b60208301905092915050565b6101a8816104b4565b82525050565b6101b781610365565b6101c181846103ad565b92506101cc82610331565b8060005b838110156101fd5781516101e4878261016f565b96506101ef83610386565b9250506001810190506101d0565b505050505050565b600061021082610370565b61021a81856103b8565b93506102258361033b565b8060005b8381101561025d5761023a82610553565b610244888261016f565b975061024f83610393565b925050600181019050610229565b5085935050505092915050565b60006102758261037b565b61027f81856103c9565b935061028a83610350565b8060005b838110156102c25761029f82610566565b6102a98882610187565b97506102b4836103a0565b92505060018101905061028e565b5085935050505092915050565b6102d8816104e6565b82525050565b60006102a0820190506102f460008301846101ae565b92915050565b600060408201905081810360008301526103148185610205565b90508181036020830152610328818461026a565b90509392505050565b6000819050919050565b60008190508160005260206000209050919050565b60008190508160005260206000209050919050565b600060159050919050565b600081549050919050565b600081549050919050565b6000602082019050919050565b6000600182019050919050565b6000600182019050919050565b600081905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b60006103e5826104e6565b91506103f0836104e6565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0382111561042557610424610524565b5b828201905092915050565b600061043b826104e6565b9150610446836104e6565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff048311821515161561047f5761047e610524565b5b828202905092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b60006104bf826104c6565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b60006105036104fe83610579565b61048a565b9050919050565b600061051d61051883610579565b6104aa565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061055f82546104f0565b9050919050565b6000610572825461050a565b9050919050565b60008160001c905091905056fea2646970667358221220bf18e78f84c245c19e8996d9afbcaa3ec60e02e413932b3848d7eed59feb161264736f6c63430008070033`
	wrapupAbi  = `[{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"sortValidators","outputs":[{"internalType":"address[21]","name":"_validators","type":"address[21]"}],"stateMutability":"view","type":"function"}]`
)

/*
*
// SPDX-License-Identifier: GPL-3.0
pragma solidity >=0.8.0 <0.9.0;

	contract SyncNewValidatorSet {
	    constructor() {}

	    address[] _candidates = [
	        0x0000000000000000000000000000000000000064,
	        0x0000000000000000000000000000000000000065,
	        0x0000000000000000000000000000000000000066,
	        0x0000000000000000000000000000000000000067,
	        0x0000000000000000000000000000000000000068,
	        0x0000000000000000000000000000000000000069,
	        0x000000000000000000000000000000000000006a,
	        0x000000000000000000000000000000000000006b,
	        0x000000000000000000000000000000000000006C,
	        0x000000000000000000000000000000000000006D,
	        0x000000000000000000000000000000000000006E,
	        0x000000000000000000000000000000000000006F,
	        0x0000000000000000000000000000000000000070,
	        0x0000000000000000000000000000000000000071,
	        0x0000000000000000000000000000000000000072,
	        0x0000000000000000000000000000000000000073,
	        0x0000000000000000000000000000000000000074,
	        0x0000000000000000000000000000000000000075,
	        0x0000000000000000000000000000000000000076,
	        0x0000000000000000000000000000000000000077,
	        0x0000000000000000000000000000000000000078
	    ];
	    uint256[] _weights = [
	        uint256(1000000),
	        uint256(2000000),
	        uint256(3000000),
	        uint256(4000000),
	        uint256(5000000),
	        uint256(6000000),
	        uint256(7000000),
	        uint256(8000000),
	        uint256(9000000),
	        uint256(10000000),
	        uint256(11000000),
	        uint256(12000000),
	        uint256(13000000),
	        uint256(14000000),
	        uint256(15000000),
	        uint256(16000000),
	        uint256(17000000),
	        uint256(18000000),
	        uint256(19000000),
	        uint256(20000000),
	        uint256(21000000)
	    ];
	    bool[] _isTrustedOrganizations = [
	        false,
			false,
			false,
			false,
			false,
			false,
			false,
			false,
			false,
			false,
			true,
			true,
			true,
			true,
			true,
			true,
			true,
			true,
			true,
			true,
			true
	    ];
	    bool[] _isMaintainings = [
	        false,
			false,
			false,
			false,
			false,
			false,
			false,
			false,
			false,
			false,
			false,
			false,
			false,
			false,
			false,
			false,
			false,
			false,
			false,
			false,
			false
	    ];
	    uint256 _maxValidatorNumber = 21;
	    uint256 _maxPrioritizedValidatorNumber = 11;

	    function pickValidatorSet() public view returns (address[] memory _result) {
	        bytes memory _payload = abi.encodeWithSignature(
	            "pickValidatorSet(address[],uint256[],bool[],bool[],uint256,uint256)",
	            _candidates,
	            _weights,
	            _isTrustedOrganizations,
	            _isMaintainings,
	            _maxValidatorNumber,
	            _maxPrioritizedValidatorNumber
	        );
	        bool _success = true;

	        uint256 _payloadLength = _payload.length;
	        uint256 _resultLength = 0x20 * _candidates.length + 0x40;
	        address _smc = address(0x68);

	        assembly {
	            let _payloadStart := add(_payload, 0x20)

	            if iszero(staticcall(gas(), _smc, _payloadStart, _payloadLength, _result, _resultLength)) {
	                _success := 0
	            }

	            if iszero(returndatasize()) {
	                _success := 0
	            }

	            _result := add(_result, 0x20)
	        }

	        require(_success, "PrecompileUsageSortValidators: call to precompile fails");
	    }
	}
*/
const (
	syncNewValidatorSetCode = `6080604052604051806102a00160405280606473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606c73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606d73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606e73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001606f73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607073ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001607873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681525060009060156200044f92919062000755565b50604051806102a00160405280620f42408152602001621e84808152602001622dc6c08152602001623d09008152602001624c4b408152602001625b8d808152602001626acfc08152602001627a1200815260200162895440815260200162989680815260200162a7d8c0815260200162b71b00815260200162c65d40815260200162d59f80815260200162e4e1c0815260200162f42400815260200163010366408152602001630112a8808152602001630121eac081526020016301312d0081526020016301406f4081525060019060156200052e929190620007e4565b50604051806102a001604052806000151515158152602001600015151515815260200160001515151581526020016000151515158152602001600015151515815260200160001515151581526020016000151515158152602001600015151515815260200160001515151581526020016000151515158152602001600115151515815260200160011515151581526020016001151515158152602001600115151515815260200160011515151581526020016001151515158152602001600115151515815260200160011515151581526020016001151515158152602001600115151515815260200160011515151581525060029060156200063292919062000836565b50604051806102a001604052806000151515158152602001600015151515815260200160001515151581526020016000151515158152602001600015151515815260200160001515151581526020016000151515158152602001600015151515815260200160001515151581526020016000151515158152602001600015151515815260200160001515151581526020016000151515158152602001600015151515815260200160001515151581526020016000151515158152602001600015151515815260200160001515151581526020016000151515158152602001600015151515815260200160001515151581525060039060156200073692919062000836565b506015600455600b6005553480156200074e57600080fd5b5062000902565b828054828255906000526020600020908101928215620007d1579160200282015b82811115620007d05782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055509160200191906001019062000776565b5b509050620007e09190620008e3565b5090565b82805482825590600052602060002090810192821562000823579160200282015b828111156200082257825182559160200191906001019062000805565b5b509050620008329190620008e3565b5090565b82805482825590600052602060002090601f01602090048101928215620008d05791602002820160005b838211156200089f57835183826101000a81548160ff021916908315150217905550926020019260010160208160000104928301926001030262000860565b8015620008ce5782816101000a81549060ff02191690556001016020816000010492830192600103026200089f565b505b509050620008df9190620008e3565b5090565b5b80821115620008fe576000816000905550600101620008e4565b5090565b61145380620009126000396000f3fe608060405234801561001057600080fd5b506004361061002b5760003560e01c8063c80c0b6c14610030575b600080fd5b61003861004e565b6040516100459190610b91565b60405180910390f35b606060008060016002600360045460055460405160240161007496959493929190610bb3565b6040516020818303038152906040527f9fd97522000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090506000600190506000825190506000604060008054905060206101159190610d8c565b61011f9190610d36565b90506000606890506020850182878583855afa61013b57600094505b3d61014557600094505b602087019650508361018c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161018390610c30565b60405180910390fd5b505050505090565b60006101a083836101c4565b60208301905092915050565b60006101b88383610b73565b60208301905092915050565b6101cd81610e1d565b82525050565b60006101de82610c9f565b6101e88185610cf2565b93506101f383610c50565b8060005b8381101561022457815161020b8882610194565b975061021683610ccb565b9250506001810190506101f7565b5085935050505092915050565b600061023c82610caa565b6102468185610cf2565b935061025183610c60565b8060005b838110156102895761026682611208565b6102708882610194565b975061027b83610cd8565b925050600181019050610255565b5085935050505092915050565b60006102a182610cb5565b6102ab8185610d03565b9350836102b784610c75565b60006001156105e4575b836001602003820110156105e35781546102e3886102de83610e7f565b610b41565b6020880197506102fb886102f683610fb7565b610b41565b6020880197506103138861030e836110d5565b610b41565b60208801975061032b8861032683611123565b610b41565b6020880197506103438861033e8361113d565b610b41565b60208801975061035b8861035683611157565b610b41565b6020880197506103738861036e83611171565b610b41565b60208801975061038b886103868361118b565b610b41565b6020880197506103a38861039e836111a5565b610b41565b6020880197506103bb886103b6836111bf565b610b41565b6020880197506103d3886103ce83610eb3565b610b41565b6020880197506103eb886103e683610ecd565b610b41565b602088019750610403886103fe83610ee7565b610b41565b60208801975061041b8861041683610f01565b610b41565b6020880197506104338861042e83610f1b565b610b41565b60208801975061044b8861044683610f35565b610b41565b6020880197506104638861045e83610f4f565b610b41565b60208801975061047b8861047683610f69565b610b41565b6020880197506104938861048e83610f83565b610b41565b6020880197506104ab886104a683610f9d565b610b41565b6020880197506104c3886104be83610fd1565b610b41565b6020880197506104db886104d683610feb565b610b41565b6020880197506104f3886104ee83611005565b610b41565b60208801975061050b886105068361101f565b610b41565b6020880197506105238861051e83611039565b610b41565b60208801975061053b8861053683611053565b610b41565b6020880197506105538861054e8361106d565b610b41565b60208801975061056b8861056683611087565b610b41565b6020880197506105838861057e836110a1565b610b41565b60208801975061059b88610596836110bb565b610b41565b6020880197506105b3886105ae836110ef565b610b41565b6020880197506105cb886105c683611109565b610b41565b602088019750600183019250506020810190506102c1565b5b600115610acf57815484821015610614576106078861060283610e7f565b610b41565b6020880197506001820191505b8482101561063b5761062e8861062983610fb7565b610b41565b6020880197506001820191505b848210156106625761065588610650836110d5565b610b41565b6020880197506001820191505b848210156106895761067c8861067783611123565b610b41565b6020880197506001820191505b848210156106b0576106a38861069e8361113d565b610b41565b6020880197506001820191505b848210156106d7576106ca886106c583611157565b610b41565b6020880197506001820191505b848210156106fe576106f1886106ec83611171565b610b41565b6020880197506001820191505b8482101561072557610718886107138361118b565b610b41565b6020880197506001820191505b8482101561074c5761073f8861073a836111a5565b610b41565b6020880197506001820191505b848210156107735761076688610761836111bf565b610b41565b6020880197506001820191505b8482101561079a5761078d8861078883610eb3565b610b41565b6020880197506001820191505b848210156107c1576107b4886107af83610ecd565b610b41565b6020880197506001820191505b848210156107e8576107db886107d683610ee7565b610b41565b6020880197506001820191505b8482101561080f57610802886107fd83610f01565b610b41565b6020880197506001820191505b84821015610836576108298861082483610f1b565b610b41565b6020880197506001820191505b8482101561085d576108508861084b83610f35565b610b41565b6020880197506001820191505b84821015610884576108778861087283610f4f565b610b41565b6020880197506001820191505b848210156108ab5761089e8861089983610f69565b610b41565b6020880197506001820191505b848210156108d2576108c5886108c083610f83565b610b41565b6020880197506001820191505b848210156108f9576108ec886108e783610f9d565b610b41565b6020880197506001820191505b84821015610920576109138861090e83610fd1565b610b41565b6020880197506001820191505b848210156109475761093a8861093583610feb565b610b41565b6020880197506001820191505b8482101561096e576109618861095c83611005565b610b41565b6020880197506001820191505b8482101561099557610988886109838361101f565b610b41565b6020880197506001820191505b848210156109bc576109af886109aa83611039565b610b41565b6020880197506001820191505b848210156109e3576109d6886109d183611053565b610b41565b6020880197506001820191505b84821015610a0a576109fd886109f88361106d565b610b41565b6020880197506001820191505b84821015610a3157610a2488610a1f83611087565b610b41565b6020880197506001820191505b84821015610a5857610a4b88610a46836110a1565b610b41565b6020880197506001820191505b84821015610a7f57610a7288610a6d836110bb565b610b41565b6020880197506001820191505b84821015610aa657610a9988610a94836110ef565b610b41565b6020880197506001820191505b84821015610acd57610ac088610abb83611109565b610b41565b6020880197506001820191505b505b8694505050505092915050565b6000610ae782610cc0565b610af18185610d14565b9350610afc83610c8a565b8060005b83811015610b3457610b118261121b565b610b1b88826101ac565b9750610b2683610ce5565b925050600181019050610b00565b5085935050505092915050565b610b4a81610e2f565b82525050565b6000610b5d603783610d25565b9150610b68826113ce565b604082019050919050565b610b7c81610e5b565b82525050565b610b8b81610e5b565b82525050565b60006020820190508181036000830152610bab81846101d3565b905092915050565b600060c0820190508181036000830152610bcd8189610231565b90508181036020830152610be18188610adc565b90508181036040830152610bf58187610296565b90508181036060830152610c098186610296565b9050610c186080830185610b82565b610c2560a0830184610b82565b979650505050505050565b60006020820190508181036000830152610c4981610b50565b9050919050565b6000819050602082019050919050565b60008190508160005260206000209050919050565b60008190508160005260206000209050919050565b60008190508160005260206000209050919050565b600081519050919050565b600081549050919050565b600081549050919050565b600081549050919050565b6000602082019050919050565b6000600182019050919050565b6000600182019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b6000610d4182610e5b565b9150610d4c83610e5b565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115610d8157610d806111d9565b5b828201905092915050565b6000610d9782610e5b565b9150610da283610e5b565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0483118215151615610ddb57610dda6111d9565b5b828202905092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600060ff82169050919050565b6000819050919050565b6000610e2882610e3b565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b6000610e78610e738361122e565b610de6565b9050919050565b6000610e92610e8d8361122e565b610e06565b9050919050565b6000610eac610ea78361122e565b610e13565b9050919050565b6000610ec6610ec18361139a565b610e06565b9050919050565b6000610ee0610edb836113a7565b610e06565b9050919050565b6000610efa610ef5836113c1565b610e06565b9050919050565b6000610f14610f0f8361123b565b610e06565b9050919050565b6000610f2e610f2983611248565b610e06565b9050919050565b6000610f48610f4383611255565b610e06565b9050919050565b6000610f62610f5d83611262565b610e06565b9050919050565b6000610f7c610f778361126f565b610e06565b9050919050565b6000610f96610f918361127c565b610e06565b9050919050565b6000610fb0610fab83611289565b610e06565b9050919050565b6000610fca610fc5836113b4565b610e06565b9050919050565b6000610fe4610fdf83611296565b610e06565b9050919050565b6000610ffe610ff9836112a3565b610e06565b9050919050565b6000611018611013836112bd565b610e06565b9050919050565b600061103261102d836112ca565b610e06565b9050919050565b600061104c611047836112d7565b610e06565b9050919050565b6000611066611061836112e4565b610e06565b9050919050565b600061108061107b836112f1565b610e06565b9050919050565b600061109a611095836112fe565b610e06565b9050919050565b60006110b46110af8361130b565b610e06565b9050919050565b60006110ce6110c983611318565b610e06565b9050919050565b60006110e86110e3836112b0565b610e06565b9050919050565b60006111026110fd83611325565b610e06565b9050919050565b600061111c61111783611332565b610e06565b9050919050565b60006111366111318361133f565b610e06565b9050919050565b600061115061114b8361134c565b610e06565b9050919050565b600061116a61116583611359565b610e06565b9050919050565b600061118461117f83611366565b610e06565b9050919050565b600061119e61119983611373565b610e06565b9050919050565b60006111b86111b383611380565b610e06565b9050919050565b60006111d26111cd8361138d565b610e06565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006112148254610e65565b9050919050565b60006112278254610e99565b9050919050565b60008160001c9050919050565b60008160681c9050919050565b60008160701c9050919050565b60008160781c9050919050565b60008160801c9050919050565b60008160881c9050919050565b60008160901c9050919050565b60008160981c9050919050565b60008160a01c9050919050565b60008160a81c9050919050565b60008160101c9050919050565b60008160b01c9050919050565b60008160b81c9050919050565b60008160c01c9050919050565b60008160c81c9050919050565b60008160d01c9050919050565b60008160d81c9050919050565b60008160e01c9050919050565b60008160e81c9050919050565b60008160f01c9050919050565b60008160f81c9050919050565b60008160181c9050919050565b60008160201c9050919050565b60008160281c9050919050565b60008160301c9050919050565b60008160381c9050919050565b60008160401c9050919050565b60008160481c9050919050565b60008160501c9050919050565b60008160581c9050919050565b60008160081c9050919050565b60008160601c9050919050565b7f507265636f6d70696c655573616765536f727456616c696461746f72733a206360008201527f616c6c20746f20707265636f6d70696c65206661696c7300000000000000000060208201525056fea2646970667358221220e868c9a09b81e4664ce28d55702b00806d1d7246586803112abff974af589f8a64736f6c63430008070033`
	syncNewValidatorSetAbi  = `[{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"pickValidatorSet","outputs":[{"internalType":"address[]","name":"_result","type":"address[]"}],"stateMutability":"view","type":"function"}]`
)

var (
	caller             = common.BytesToAddress([]byte("sender"))
	expectedValidators = []common.Address{
		common.BytesToAddress([]byte{120}),
		common.BytesToAddress([]byte{119}),
		common.BytesToAddress([]byte{118}),
		common.BytesToAddress([]byte{117}),
		common.BytesToAddress([]byte{116}),
		common.BytesToAddress([]byte{115}),
		common.BytesToAddress([]byte{114}),
		common.BytesToAddress([]byte{113}),
		common.BytesToAddress([]byte{112}),
		common.BytesToAddress([]byte{111}),
		common.BytesToAddress([]byte{110}),
		common.BytesToAddress([]byte{109}),
		common.BytesToAddress([]byte{108}),
		common.BytesToAddress([]byte{107}),
		common.BytesToAddress([]byte{106}),
		common.BytesToAddress([]byte{105}),
		common.BytesToAddress([]byte{104}),
		common.BytesToAddress([]byte{103}),
		common.BytesToAddress([]byte{102}),
		common.BytesToAddress([]byte{101}),
		common.BytesToAddress([]byte{100}),
	}
)

/*
*
verifyHeadersTestCode represents the following smart contract code
// SPDX-License-Identifier: GPL-3.0
pragma solidity >=0.8.0 <0.9.0;

contract VerifyHeaderTestContract {

	    constructor() {}

	    function verify(bytes memory header1, bytes memory header2) public view returns (bool) {
	        bytes memory payload = abi.encodeWithSignature("validatingDoubleSignProof(bytes,bytes)", header1, header2);
	        uint payloadLength = payload.length;
	        address _smc = address(0x67);
	        uint[1] memory _output;
	        assembly {
	            let payloadStart := add(payload, 32)
	            if iszero(staticcall(0, _smc, payloadStart, payloadLength, _output, 0x20)) {
	                revert(0, 0)
	            }
	        }
	        return (_output[0] != 0);
	    }
	}
*/
const (
	verifyHeadersTestCode = "608060405234801561001057600080fd5b50610299806100206000396000f3fe608060405234801561001057600080fd5b506004361061002b5760003560e01c8063f7e83aee14610030575b600080fd5b61004361003e36600461018b565b610057565b604051901515815260200160405180910390f35b600080838360405160240161006d929190610235565b60408051601f198184030181529190526020810180516001600160e01b031663580a316360e01b179052805190915060676100a66100ca565b602084016020828583866000fa6100bc57600080fd5b505115159695505050505050565b60405180602001604052806001906020820280368337509192915050565b634e487b7160e01b600052604160045260246000fd5b600082601f83011261010f57600080fd5b813567ffffffffffffffff8082111561012a5761012a6100e8565b604051601f8301601f19908116603f01168101908282118183101715610152576101526100e8565b8160405283815286602085880101111561016b57600080fd5b836020870160208301376000602085830101528094505050505092915050565b6000806040838503121561019e57600080fd5b823567ffffffffffffffff808211156101b657600080fd5b6101c2868387016100fe565b935060208501359150808211156101d857600080fd5b506101e5858286016100fe565b9150509250929050565b6000815180845260005b81811015610215576020818501810151868301820152016101f9565b506000602082860101526020601f19601f83011685010191505092915050565b60408152600061024860408301856101ef565b828103602084015261025a81856101ef565b9594505050505056fea2646970667358221220e689890bbe17c2e97389470ed4baa21af25fd9cd6348d7511924615440d967d364736f6c63430008110033"
	verifyHeadersTestAbi  = `[{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"bytes","name":"header1","type":"bytes"},{"internalType":"bytes","name":"header2","type":"bytes"}],"name":"verify","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"}]`
)

type Scenario struct {
	Address       common.Address
	Weight        *big.Int
	IsPriority    bool
	IsMaintaining bool
}

func getAddresses(scenarios []Scenario) []common.Address {
	var result []common.Address
	for _, s := range scenarios {
		result = append(result, s.Address)
	}

	return result
}

func getWeights(scenarios []Scenario) []*big.Int {
	var result []*big.Int
	for _, s := range scenarios {
		result = append(result, s.Weight)
	}

	return result
}

func getPriorities(scenarios []Scenario) []bool {
	var result []bool
	for _, s := range scenarios {
		result = append(result, s.IsPriority)
	}

	return result
}

func setPrioritiesAt(scenarios []Scenario, indexes ...int64) {
	for _, i := range indexes {
		scenarios[i].IsPriority = true
	}
}

func getMaintaining(scenarios []Scenario) []bool {
	var result []bool
	for _, s := range scenarios {
		result = append(result, s.IsMaintaining)
	}

	return result
}

func setMaintainingAt(scenarios []Scenario, indexes ...int64) {
	for _, i := range indexes {
		scenarios[i].IsMaintaining = true
	}
}

var (
	scenarios = []Scenario{
		{
			Address:       common.BytesToAddress([]byte{100}),
			Weight:        big.NewInt(1_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{101}),
			Weight:        big.NewInt(2_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{102}),
			Weight:        big.NewInt(3_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{103}),
			Weight:        big.NewInt(4_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{104}),
			Weight:        big.NewInt(5_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{105}),
			Weight:        big.NewInt(6_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{106}),
			Weight:        big.NewInt(7_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{107}),
			Weight:        big.NewInt(8_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{108}),
			Weight:        big.NewInt(9_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{109}),
			Weight:        big.NewInt(10_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{110}),
			Weight:        big.NewInt(11_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{111}),
			Weight:        big.NewInt(12_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{112}),
			Weight:        big.NewInt(13_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{113}),
			Weight:        big.NewInt(14_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{114}),
			Weight:        big.NewInt(15_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{115}),
			Weight:        big.NewInt(16_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{116}),
			Weight:        big.NewInt(17_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{117}),
			Weight:        big.NewInt(18_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{118}),
			Weight:        big.NewInt(19_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{119}),
			Weight:        big.NewInt(20_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{120}),
			Weight:        big.NewInt(21_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
	}
	addressesTest = []common.Address{
		common.BytesToAddress([]byte{100}),
		common.BytesToAddress([]byte{101}),
		common.BytesToAddress([]byte{102}),
		common.BytesToAddress([]byte{103}),
		common.BytesToAddress([]byte{104}),
		common.BytesToAddress([]byte{105}),
		common.BytesToAddress([]byte{106}),
		common.BytesToAddress([]byte{107}),
		common.BytesToAddress([]byte{108}),
		common.BytesToAddress([]byte{109}),
		common.BytesToAddress([]byte{110}),
		common.BytesToAddress([]byte{111}),
		common.BytesToAddress([]byte{112}),
		common.BytesToAddress([]byte{113}),
		common.BytesToAddress([]byte{114}),
		common.BytesToAddress([]byte{115}),
		common.BytesToAddress([]byte{116}),
		common.BytesToAddress([]byte{117}),
		common.BytesToAddress([]byte{118}),
		common.BytesToAddress([]byte{119}),
		common.BytesToAddress([]byte{120}),
	}
	weightsTest = []*big.Int{
		big.NewInt(1_000_000),
		big.NewInt(2_000_000),
		big.NewInt(3_000_000),
		big.NewInt(4_000_000),
		big.NewInt(5_000_000),
		big.NewInt(6_000_000),
		big.NewInt(7_000_000),
		big.NewInt(8_000_000),
		big.NewInt(9_000_000),
		big.NewInt(10_000_000),
		big.NewInt(11_000_000),
		big.NewInt(12_000_000),
		big.NewInt(13_000_000),
		big.NewInt(14_000_000),
		big.NewInt(15_000_000),
		big.NewInt(16_000_000),
		big.NewInt(17_000_000),
		big.NewInt(18_000_000),
		big.NewInt(19_000_000),
		big.NewInt(20_000_000),
		big.NewInt(22_000_000),
	}
)

func TestSort(t *testing.T) {
	addrs := []common.Address{
		common.BytesToAddress([]byte{102}),
		common.BytesToAddress([]byte{103}),
		common.BytesToAddress([]byte{104}),
		common.BytesToAddress([]byte{105}),
		common.BytesToAddress([]byte{106}),
	}

	totalBalances := []*big.Int{
		big.NewInt(10),
		big.NewInt(2),
		big.NewInt(11),
		big.NewInt(15),
		big.NewInt(1),
	}

	expectedAddrs := []common.Address{
		common.BytesToAddress([]byte{105}),
		common.BytesToAddress([]byte{104}),
		common.BytesToAddress([]byte{102}),
		common.BytesToAddress([]byte{103}),
		common.BytesToAddress([]byte{106}),
	}

	expectedBalances := []*big.Int{
		big.NewInt(15),
		big.NewInt(11),
		big.NewInt(10),
		big.NewInt(2),
		big.NewInt(1),
	}

	sortValidators(addrs, totalBalances)
	for i, val := range addrs {
		println(fmt.Sprintf("%s:%s", val.Hex(), totalBalances[i].String()))
		if expectedBalances[i].Cmp(totalBalances[i]) != 0 {
			t.Fatal(fmt.Sprintf("mismatched balance at %d, expected:%s got:%s", i, expectedBalances[i].String(), totalBalances[i].String()))
		}
		if expectedAddrs[i].Hex() != val.Hex() {
			t.Fatal(fmt.Sprintf("mismatched addr at %d, expected:%s got:%s", i, expectedValidators[i].Hex(), val.Hex()))
		}
	}
}

// TestConsortiumValidatorSorting_Run sorts 21 validators successfully
func TestConsortiumValidatorSorting_Run(t *testing.T) {
	var (
		statedb, _ = state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
	)

	smcAbi, err := abi.JSON(strings.NewReader(consortiumSortValidatorAbi))
	if err != nil {
		t.Fatal(err)
	}

	input, err := smcAbi.Pack(sortValidatorsMethod, addressesTest, weightsTest)

	if err != nil {
		t.Fatal(err)
	}

	evm, err := newEVM(caller, statedb)
	if err != nil {
		t.Fatal(err)
	}
	c := &consortiumValidatorSorting{caller: AccountRef(caller), evm: evm}
	output, err := c.Run(input)
	if err != nil {
		t.Fatal(err)
	}
	//println(common.Bytes2Hex(output))

	res, err := smcAbi.Methods[sortValidatorsMethod].Outputs.Unpack(output)
	if err != nil {
		t.Fatal(err)
	}
	sortedValidators := *abi.ConvertType(res[0], new([21]common.Address)).(*[21]common.Address)
	if len(expectedValidators) != len(sortedValidators) {
		t.Fatal(fmt.Sprintf("expected len %d, got %v", 21, len(sortedValidators)))
	}
	for i, addr := range sortedValidators {
		//println(addr.Hex())
		if expectedValidators[i].Hex() != addr.Hex() {
			t.Fatal(fmt.Sprintf("mismatched addr at %d, expected:%s got:%s", i, expectedValidators[i].Hex(), addr.Hex()))
		}
	}
}

// TestConsortiumValidatorSorting_Run2 simulates a call from a user who trigger system contract to call `sort` precompiled contract
func TestConsortiumValidatorSorting_Run2(t *testing.T) {
	var (
		statedb, _ = state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
	)
	smcAbi, err := abi.JSON(strings.NewReader(wrapupAbi))
	if err != nil {
		t.Fatal(err)
	}
	input, err := smcAbi.Pack(sortValidatorsMethod)
	if err != nil {
		t.Fatal(err)
	}

	evm, err := newEVM(caller, statedb)
	if err != nil {
		t.Fatal(err)
	}
	_, contract, _, err := evm.Create(AccountRef(caller), common.FromHex(wrapupCode), math.MaxUint64/2, big0)
	if err != nil {
		t.Fatal(err)
	}

	// set this contract into consortiumV2Contracts to make it become a system contract
	evm.chainConfig.ConsortiumV2Contracts.SlashIndicator = contract

	ret, _, err := evm.StaticCall(AccountRef(caller), contract, input, 1000000)
	if err != nil {
		t.Fatal(err)
	}

	res, err := smcAbi.Methods[sortValidatorsMethod].Outputs.Unpack(ret)
	if err != nil {
		t.Fatal(err)
	}

	sortedValidators := *abi.ConvertType(res[0], new([21]common.Address)).(*[21]common.Address)
	if len(expectedValidators) != len(sortedValidators) {
		t.Fatal(fmt.Sprintf("expected len 21, got %v", len(sortedValidators)))
	}
	for i, addr := range sortedValidators {
		if expectedValidators[i].Hex() != addr.Hex() {
			t.Fatal(fmt.Sprintf("mismatched addr at %d, expected:%s got:%s", i, expectedValidators[i].Hex(), addr.Hex()))
		}
	}
}

// TestConsortiumVerifyHeaders_verify tests verify function
func TestConsortiumVerifyHeaders_verify(t *testing.T) {
	header1, header2, err := prepareHeader(big1)
	if err != nil {
		t.Fatal(err)
	}
	c := &consortiumVerifyHeaders{evm: &EVM{chainConfig: &params.ChainConfig{ChainID: big1}}}
	if !c.verify(*fromHeader(header1, big1), *fromHeader(header2, big1)) {
		t.Fatal("expected true, got false")
	}
}

// TestConsortiumVerifyHeaders_Run init 2 headers, pack them and call `Run` function directly
func TestConsortiumVerifyHeaders_Run(t *testing.T) {
	var (
		statedb, _ = state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
	)
	smcAbi, err := abi.JSON(strings.NewReader(consortiumVerifyHeadersAbi))
	if err != nil {
		t.Fatal(err)
	}
	evm, err := newEVM(caller, statedb)
	if err != nil {
		t.Fatal(err)
	}
	header1, header2, err := prepareHeader(evm.chainConfig.ChainID)
	if err != nil {
		t.Fatal(err)
	}
	encodedHeader1, err := fromHeader(header1, big1).Bytes()
	if err != nil {
		t.Fatal(err)
	}
	encodedHeader2, err := fromHeader(header2, big1).Bytes()
	if err != nil {
		t.Fatal(err)
	}
	input, err := smcAbi.Pack(verifyHeaders, encodedHeader1, encodedHeader2)
	if err != nil {
		t.Fatal(err)
	}
	c := &consortiumVerifyHeaders{evm: evm, caller: AccountRef(caller)}
	result, err := c.Run(input)
	if err != nil {
		t.Fatal(err)
	}
	if len(result) != 32 {
		t.Fatal(fmt.Sprintf("expected len 32 got %d", len(result)))
	}
	if result[len(result)-1] != 1 {
		t.Fatal(fmt.Sprintf("expected 1 (true) got %d", result[len(result)-1]))
	}
}

// TestConsortiumVerifyHeaders_Run2 deploys smart contract and call precompiled contracts via this contract
func TestConsortiumVerifyHeaders_Run2(t *testing.T) {
	var (
		statedb, _ = state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
	)
	smcAbi, err := abi.JSON(strings.NewReader(verifyHeadersTestAbi))
	if err != nil {
		t.Fatal(err)
	}
	header1, header2, err := prepareHeader(big1)
	if err != nil {
		t.Fatal(err)
	}
	encodedHeader1, err := fromHeader(header1, big1).Bytes()
	if err != nil {
		t.Fatal(err)
	}
	encodedHeader2, err := fromHeader(header2, big1).Bytes()
	if err != nil {
		t.Fatal(err)
	}
	input, err := smcAbi.Pack("verify", encodedHeader1, encodedHeader2)
	if err != nil {
		t.Fatal(err)
	}
	evm, err := newEVM(caller, statedb)
	if err != nil {
		t.Fatal(err)
	}
	_, contract, _, err := evm.Create(AccountRef(caller), common.FromHex(verifyHeadersTestCode), math.MaxUint64/2, big0)
	if err != nil {
		t.Fatal(err)
	}

	// set this contract into consortiumV2Contracts to make it become a system contract
	evm.chainConfig.ConsortiumV2Contracts.SlashIndicator = contract

	ret, _, err := evm.StaticCall(AccountRef(caller), contract, input, 1000000)
	if err != nil {
		t.Fatal(err)
	}

	res, err := smcAbi.Methods["verify"].Outputs.Unpack(ret)
	if err != nil {
		t.Fatal(err)
	}
	result := *abi.ConvertType(res[0], new(bool)).(*bool)
	if !result {
		t.Fatal("expected true got false")
	}
}

// TestArrangeValidatorCandidates arranges 21 candidates with 11 trusted nodes (ordering)
func TestArrangeValidatorCandidates(t *testing.T) {
	setPrioritiesAt(scenarios, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20)
	isTrustedOrganizations := getPriorities(scenarios)
	candidates := getAddresses(scenarios)
	weights := getWeights(scenarios)

	newValidatorCount := uint64(21)
	maxPrioritizedValidatorNumber := big.NewInt(11)

	sortValidators(candidates, weights)
	arrangeValidatorCandidates(&candidates, newValidatorCount, isTrustedOrganizations, maxPrioritizedValidatorNumber)

	expectedCandidates := []common.Address{
		common.BytesToAddress([]byte{110}),
		common.BytesToAddress([]byte{109}),
		common.BytesToAddress([]byte{108}),
		common.BytesToAddress([]byte{107}),
		common.BytesToAddress([]byte{106}),
		common.BytesToAddress([]byte{105}),
		common.BytesToAddress([]byte{104}),
		common.BytesToAddress([]byte{103}),
		common.BytesToAddress([]byte{102}),
		common.BytesToAddress([]byte{101}),
		common.BytesToAddress([]byte{100}),

		common.BytesToAddress([]byte{120}),
		common.BytesToAddress([]byte{119}),
		common.BytesToAddress([]byte{118}),
		common.BytesToAddress([]byte{117}),
		common.BytesToAddress([]byte{116}),
		common.BytesToAddress([]byte{115}),
		common.BytesToAddress([]byte{114}),
		common.BytesToAddress([]byte{113}),
		common.BytesToAddress([]byte{112}),
		common.BytesToAddress([]byte{111}),
	}
	for i, candidate := range candidates {
		if !bytes.Equal(expectedCandidates[i].Bytes(), candidate.Bytes()) {
			t.Fatal(fmt.Sprintf("mismatched candidate address at %d, expected:%s got:%s", i, expectedCandidates[i].Hex(), candidate.Hex()))
		}
	}
}

// TestArrangeValidatorCandidates_RandomTrustedOrganizations arranges 21 candidates with 11 trusted nodes (randomly)
func TestArrangeValidatorCandidates_RandomTrustedOrganizations(t *testing.T) {
	setPrioritiesAt(scenarios, 2, 5, 8, 10, 11, 13, 14, 17, 18, 19, 20)
	isTrustedOrganizations := getPriorities(scenarios)
	candidates := getAddresses(scenarios)
	weights := getWeights(scenarios)

	newValidatorCount := uint64(21)
	maxPrioritizedValidatorNumber := big.NewInt(11)

	sortValidators(candidates, weights)
	arrangeValidatorCandidates(&candidates, newValidatorCount, isTrustedOrganizations, maxPrioritizedValidatorNumber)

	expectedCandidates := []common.Address{
		common.BytesToAddress([]byte{118}),
		common.BytesToAddress([]byte{115}),
		common.BytesToAddress([]byte{112}),
		common.BytesToAddress([]byte{110}),
		common.BytesToAddress([]byte{109}),
		common.BytesToAddress([]byte{107}),
		common.BytesToAddress([]byte{106}),
		common.BytesToAddress([]byte{103}),
		common.BytesToAddress([]byte{102}),
		common.BytesToAddress([]byte{101}),
		common.BytesToAddress([]byte{100}),

		common.BytesToAddress([]byte{120}),
		common.BytesToAddress([]byte{119}),
		common.BytesToAddress([]byte{117}),
		common.BytesToAddress([]byte{116}),
		common.BytesToAddress([]byte{114}),
		common.BytesToAddress([]byte{113}),
		common.BytesToAddress([]byte{111}),
		common.BytesToAddress([]byte{108}),
		common.BytesToAddress([]byte{105}),
		common.BytesToAddress([]byte{104}),
	}

	for i, candidate := range candidates {
		if !bytes.Equal(expectedCandidates[i].Bytes(), candidate.Bytes()) {
			t.Fatal(fmt.Sprintf("mismatched candidate address at %d, expected:%s got:%s", i, expectedCandidates[i].Hex(), candidate.Hex()))
		}
	}
}

// TestArrangeValidatorCandidates_Max5Prioritized arranges 21 candidates with 5 trusted nodes (ordering)
func TestArrangeValidatorCandidates_Max5Prioritized(t *testing.T) {
	setPrioritiesAt(scenarios, 16, 17, 18, 19, 20)
	isTrustedOrganizations := getPriorities(scenarios)
	candidates := getAddresses(scenarios)
	weights := getWeights(scenarios)

	newValidatorCount := uint64(21)
	maxPrioritizedValidatorNumber := big.NewInt(11)

	sortValidators(candidates, weights)
	arrangeValidatorCandidates(&candidates, newValidatorCount, isTrustedOrganizations, maxPrioritizedValidatorNumber)

	expectedCandidates := []common.Address{
		common.BytesToAddress([]byte{104}),
		common.BytesToAddress([]byte{103}),
		common.BytesToAddress([]byte{102}),
		common.BytesToAddress([]byte{101}),
		common.BytesToAddress([]byte{100}),

		common.BytesToAddress([]byte{120}),
		common.BytesToAddress([]byte{119}),
		common.BytesToAddress([]byte{118}),
		common.BytesToAddress([]byte{117}),
		common.BytesToAddress([]byte{116}),
		common.BytesToAddress([]byte{115}),
		common.BytesToAddress([]byte{114}),
		common.BytesToAddress([]byte{113}),
		common.BytesToAddress([]byte{112}),
		common.BytesToAddress([]byte{111}),
		common.BytesToAddress([]byte{110}),
		common.BytesToAddress([]byte{109}),
		common.BytesToAddress([]byte{108}),
		common.BytesToAddress([]byte{107}),
		common.BytesToAddress([]byte{106}),
		common.BytesToAddress([]byte{105}),
	}
	for i, candidate := range candidates {
		if !bytes.Equal(expectedCandidates[i].Bytes(), candidate.Bytes()) {
			t.Fatal(fmt.Sprintf("mismatched candidate address at %d, expected:%s got:%s", i, expectedCandidates[i].Hex(), candidate.Hex()))
		}
	}
}

// TestArrangeValidatorCandidates_Miss5Nodes arranges 16 candidates with 5 trusted nodes (ordering)
func TestArrangeValidatorCandidates_Miss5Nodes(t *testing.T) {
	setPrioritiesAt(scenarios, 11, 12, 13, 14, 15)
	isTrustedOrganizations := getPriorities(scenarios)[5:]
	candidates := getAddresses(scenarios)[5:]
	weights := getWeights(scenarios)[5:]
	newValidatorCount := uint64(16)
	maxPrioritizedValidatorNumber := big.NewInt(11)

	sortValidators(candidates, weights)
	arrangeValidatorCandidates(&candidates, newValidatorCount, isTrustedOrganizations, maxPrioritizedValidatorNumber)

	expectedCandidates := []common.Address{
		common.BytesToAddress([]byte{114}),
		common.BytesToAddress([]byte{113}),
		common.BytesToAddress([]byte{112}),
		common.BytesToAddress([]byte{111}),
		common.BytesToAddress([]byte{110}),

		common.BytesToAddress([]byte{120}),
		common.BytesToAddress([]byte{119}),
		common.BytesToAddress([]byte{118}),
		common.BytesToAddress([]byte{117}),
		common.BytesToAddress([]byte{116}),
		common.BytesToAddress([]byte{115}),
		common.BytesToAddress([]byte{109}),
		common.BytesToAddress([]byte{108}),
		common.BytesToAddress([]byte{107}),
		common.BytesToAddress([]byte{106}),
		common.BytesToAddress([]byte{105}),
	}
	for i, candidate := range candidates {
		if !bytes.Equal(expectedCandidates[i].Bytes(), candidate.Bytes()) {
			t.Fatal(fmt.Sprintf("mismatched candidate address at %d, expected:%s got:%s", i, expectedCandidates[i].Hex(), candidate.Hex()))
		}
	}
}

// TestArrangeValidatorCandidates_Has15TrustedNodes arranges 25 candidates with 15 trusted nodes (ordering)
// while maxPrioritizedValidatorNumber is 11
func TestArrangeValidatorCandidates_Has15TrustedNodes(t *testing.T) {
	scenarios = append(scenarios, []Scenario{
		{
			Address:       common.BytesToAddress([]byte{121}),
			Weight:        big.NewInt(8_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{122}),
			Weight:        big.NewInt(8_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{123}),
			Weight:        big.NewInt(8_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
		{
			Address:       common.BytesToAddress([]byte{124}),
			Weight:        big.NewInt(8_000_000),
			IsPriority:    false,
			IsMaintaining: false,
		},
	}...)
	candidates := getAddresses(scenarios)
	weights := getWeights(scenarios)
	setPrioritiesAt(scenarios, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24)
	isTrustedOrganizations := getPriorities(scenarios)
	newValidatorCount := uint64(21)
	maxPrioritizedValidatorNumber := big.NewInt(11)

	sortValidators(candidates, weights)
	arrangeValidatorCandidates(&candidates, newValidatorCount, isTrustedOrganizations, maxPrioritizedValidatorNumber)

	expectedCandidates := []common.Address{
		common.BytesToAddress([]byte{110}),
		common.BytesToAddress([]byte{109}),
		common.BytesToAddress([]byte{108}),
		common.BytesToAddress([]byte{124}),
		common.BytesToAddress([]byte{123}),
		common.BytesToAddress([]byte{122}),
		common.BytesToAddress([]byte{121}),
		common.BytesToAddress([]byte{107}),
		common.BytesToAddress([]byte{106}),
		common.BytesToAddress([]byte{105}),
		common.BytesToAddress([]byte{104}),

		common.BytesToAddress([]byte{120}),
		common.BytesToAddress([]byte{119}),
		common.BytesToAddress([]byte{118}),
		common.BytesToAddress([]byte{117}),
		common.BytesToAddress([]byte{116}),
		common.BytesToAddress([]byte{115}),
		common.BytesToAddress([]byte{114}),
		common.BytesToAddress([]byte{113}),
		common.BytesToAddress([]byte{112}),
		common.BytesToAddress([]byte{111}),
	}
	for i, candidate := range candidates[:newValidatorCount] {
		if !bytes.Equal(expectedCandidates[i].Bytes(), candidate.Bytes()) {
			t.Fatal(fmt.Sprintf("mismatched candidate address at %d, expected:%s got:%s", i, expectedCandidates[i].Hex(), candidate.Hex()))
		}
	}
}

// TestPickCandidatesIsRunning returns unmaintained candidates
func TestPickCandidatesIsRunning(t *testing.T) {
	setMaintainingAt(scenarios, 16, 17, 18, 19, 20)
	isMaintainings := getMaintaining(scenarios)
	candidates := getAddresses(scenarios)
	newValidatorCount := uint64(21)

	result := pickCandidatesIsRunning(candidates, isMaintainings, newValidatorCount)

	expectedCandidates := []common.Address{
		common.BytesToAddress([]byte{100}),
		common.BytesToAddress([]byte{101}),
		common.BytesToAddress([]byte{102}),
		common.BytesToAddress([]byte{103}),
		common.BytesToAddress([]byte{104}),
		common.BytesToAddress([]byte{105}),
		common.BytesToAddress([]byte{106}),
		common.BytesToAddress([]byte{107}),
		common.BytesToAddress([]byte{108}),
		common.BytesToAddress([]byte{109}),
		common.BytesToAddress([]byte{110}),
		common.BytesToAddress([]byte{111}),
		common.BytesToAddress([]byte{112}),
		common.BytesToAddress([]byte{113}),
		common.BytesToAddress([]byte{114}),
		common.BytesToAddress([]byte{115}),
	}
	if len(expectedCandidates) != len(result) {
		t.Fatal(fmt.Sprintf("mismatched candidate length, expected:%d got:%d", len(expectedCandidates), len(result)))
	}

	for i, candidate := range result {
		if !bytes.Equal(expectedCandidates[i].Bytes(), candidate.Bytes()) {
			t.Fatal(fmt.Sprintf("mismatched candidate address at %d, expected:%s got:%s", i, expectedCandidates[i].Hex(), candidate.Hex()))
		}
	}
}

// TestPickCandidatesIsRunning_AllNodesMaintaining returns empty array since all candidates are maintaining
func TestPickCandidatesIsRunning_AllNodesMaintaining(t *testing.T) {
	isMaintainings := []bool{
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
	}
	newValidatorCount := uint64(21)

	result := pickCandidatesIsRunning(addressesTest, isMaintainings, newValidatorCount)

	if len(result) != 0 {
		t.Fatal(fmt.Sprintf("mismatched candidate length, expected:%d got:%d", 0, len(result)))
	}
}

// TestConsortiumPickValidatorSet_Run init 2 headers, pack them and call `Run` function directly
func TestConsortiumPickValidatorSet_Run(t *testing.T) {
	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)

	smcAbi, err := abi.JSON(strings.NewReader(consortiumPickValidatorSetAbi))
	if err != nil {
		t.Fatal(err)
	}

	isTrustedOrganizations := []bool{
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
		true,
	}
	isMaintainings := []bool{
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
		false,
	}
	maxValidatorNumber := big.NewInt(21)
	maxPrioritizedValidatorNumber := big.NewInt(11)

	expectedCandidates := []common.Address{
		common.BytesToAddress([]byte{110}),
		common.BytesToAddress([]byte{109}),
		common.BytesToAddress([]byte{108}),
		common.BytesToAddress([]byte{107}),
		common.BytesToAddress([]byte{106}),
		common.BytesToAddress([]byte{105}),
		common.BytesToAddress([]byte{104}),
		common.BytesToAddress([]byte{103}),
		common.BytesToAddress([]byte{102}),
		common.BytesToAddress([]byte{101}),
		common.BytesToAddress([]byte{100}),

		common.BytesToAddress([]byte{120}),
		common.BytesToAddress([]byte{119}),
		common.BytesToAddress([]byte{118}),
		common.BytesToAddress([]byte{117}),
		common.BytesToAddress([]byte{116}),
		common.BytesToAddress([]byte{115}),
		common.BytesToAddress([]byte{114}),
		common.BytesToAddress([]byte{113}),
		common.BytesToAddress([]byte{112}),
		common.BytesToAddress([]byte{111}),
	}

	input, err := smcAbi.Pack(pickValidatorSetMethod, addressesTest, weightsTest, isTrustedOrganizations, isMaintainings, maxValidatorNumber, maxPrioritizedValidatorNumber)

	if err != nil {
		t.Fatal(err)
	}

	evm, err := newEVM(caller, statedb)
	if err != nil {
		t.Fatal(err)
	}
	c := &consortiumPickValidatorSet{caller: AccountRef(caller), evm: evm}
	output, err := c.Run(input)
	if err != nil {
		t.Fatal(err)
	}

	res, err := smcAbi.Methods[pickValidatorSetMethod].Outputs.Unpack(output)
	if err != nil {
		t.Fatal(err)
	}
	validators := *abi.ConvertType(res[0], new([21]common.Address)).(*[21]common.Address)
	if len(expectedCandidates) != len(validators) {
		t.Fatal(fmt.Sprintf("expected len %d, got %v", maxValidatorNumber, len(validators)))
	}

	for i, addr := range validators {
		if expectedCandidates[i].Hex() != addr.Hex() {
			t.Fatal(fmt.Sprintf("mismatched addr at %d, expected:%s got:%s", i, expectedCandidates[i].Hex(), addr.Hex()))
		}
	}
}

// TestConsortiumPickValidatorSet_Run2 simulates a call from a user who trigger system contract
// to call `sort` precompiled contract
func TestConsortiumPickValidatorSet_Run3(t *testing.T) {
	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
	smcAbi, err := abi.JSON(strings.NewReader(syncNewValidatorSetAbi))
	if err != nil {
		t.Fatal(err)
	}
	input, err := smcAbi.Pack(pickValidatorSetMethod)
	if err != nil {
		t.Fatal(err)
	}

	evm, err := newEVM(caller, statedb)
	if err != nil {
		t.Fatal(err)
	}
	_, contract, _, err := evm.Create(AccountRef(caller), common.FromHex(syncNewValidatorSetCode), math.MaxUint64/2, big0)
	if err != nil {
		t.Fatal(err)
	}

	// set this contract into consortiumV2Contracts to make it become a system contract
	evm.chainConfig.ConsortiumV2Contracts.SlashIndicator = contract

	ret, _, err := evm.StaticCall(AccountRef(caller), contract, input, 1000000)
	if err != nil {
		t.Fatal(err)
	}

	res, err := smcAbi.Methods[pickValidatorSetMethod].Outputs.Unpack(ret)
	if err != nil {
		t.Fatal(err)
	}

	validators := *abi.ConvertType(res[0], new([21]common.Address)).(*[21]common.Address)

	expectedCandidates := []common.Address{
		common.BytesToAddress([]byte{110}),
		common.BytesToAddress([]byte{109}),
		common.BytesToAddress([]byte{108}),
		common.BytesToAddress([]byte{107}),
		common.BytesToAddress([]byte{106}),
		common.BytesToAddress([]byte{105}),
		common.BytesToAddress([]byte{104}),
		common.BytesToAddress([]byte{103}),
		common.BytesToAddress([]byte{102}),
		common.BytesToAddress([]byte{101}),
		common.BytesToAddress([]byte{100}),

		common.BytesToAddress([]byte{120}),
		common.BytesToAddress([]byte{119}),
		common.BytesToAddress([]byte{118}),
		common.BytesToAddress([]byte{117}),
		common.BytesToAddress([]byte{116}),
		common.BytesToAddress([]byte{115}),
		common.BytesToAddress([]byte{114}),
		common.BytesToAddress([]byte{113}),
		common.BytesToAddress([]byte{112}),
		common.BytesToAddress([]byte{111}),
	}

	if len(expectedCandidates) != len(validators) {
		t.Fatal(fmt.Sprintf("expected len 21, got %v", len(validators)))
	}

	for i, addr := range validators {
		if expectedCandidates[i].Hex() != addr.Hex() {
			t.Fatal(fmt.Sprintf("mismatched addr at %d, expected:%s got:%s", i, expectedCandidates[i].Hex(), addr.Hex()))
		}
	}
}

func prepareHeader(chainId *big.Int) (*types.Header, *types.Header, error) {
	privateKey, err := crypto.GenerateKey()
	if err != nil {
		return nil, nil, err
	}
	// init extraData with extraVanity
	extraData := bytes.Repeat([]byte{0x00}, extraVanity)

	// append to extraData with validators set
	extraData = append(extraData, common.BytesToAddress([]byte("validator1")).Bytes()...)
	extraData = append(extraData, common.BytesToAddress([]byte("validator2")).Bytes()...)

	// add extra seal space
	extraData = append(extraData, make([]byte, crypto.SignatureLength)...)

	// create header1
	header1 := &types.Header{
		ParentHash:  common.BytesToHash([]byte("11")),
		UncleHash:   common.Hash{},
		Coinbase:    crypto.PubkeyToAddress(privateKey.PublicKey),
		Root:        common.BytesToHash([]byte("123")),
		TxHash:      common.BytesToHash([]byte("abc")),
		ReceiptHash: common.BytesToHash([]byte("def")),
		Bloom:       types.Bloom{},
		Difficulty:  big.NewInt(1000),
		Number:      big.NewInt(1000),
		GasLimit:    100000000,
		GasUsed:     0,
		Time:        1000,
		Extra:       make([]byte, len(extraData)),
		MixDigest:   common.Hash{},
		Nonce:       types.EncodeNonce(1000),
	}

	// create header2
	header2 := &types.Header{
		ParentHash:  common.BytesToHash([]byte("11")),
		UncleHash:   common.Hash{},
		Coinbase:    crypto.PubkeyToAddress(privateKey.PublicKey),
		Root:        common.BytesToHash([]byte("1232")),
		TxHash:      common.BytesToHash([]byte("abcd")),
		ReceiptHash: common.BytesToHash([]byte("defd")),
		Bloom:       types.Bloom{},
		Difficulty:  big.NewInt(1000),
		Number:      big.NewInt(1000),
		GasLimit:    100000000,
		GasUsed:     0,
		Time:        1000,
		Extra:       make([]byte, len(extraData)),
		MixDigest:   common.Hash{},
		Nonce:       types.EncodeNonce(1000),
	}

	// copy extraData
	copy(header1.Extra[:], extraData)
	copy(header2.Extra[:], extraData)

	// signing and add to extraData
	sig1, err := crypto.Sign(crypto.Keccak256(consortiumRlp(header1, chainId)), privateKey)
	if err != nil {
		return nil, nil, err
	}
	sig2, err := crypto.Sign(crypto.Keccak256(consortiumRlp(header2, chainId)), privateKey)
	if err != nil {
		return nil, nil, err
	}

	copy(header1.Extra[len(header1.Extra)-crypto.SignatureLength:], sig1)
	copy(header2.Extra[len(header2.Extra)-crypto.SignatureLength:], sig2)

	return header1, header2, nil
}

func consortiumRlp(header *types.Header, chainId *big.Int) []byte {
	b := new(bytes.Buffer)
	encodeSigHeader(b, header, chainId)
	return b.Bytes()
}

func newEVM(caller common.Address, statedb StateDB) (*EVM, error) {
	evm := &EVM{
		Context: BlockContext{
			CanTransfer: func(state StateDB, addr common.Address, value *big.Int) bool { return true },
			Transfer:    func(StateDB, common.Address, common.Address, *big.Int) {},
		},
		chainConfig: params.TestChainConfig,
		StateDB:     statedb,
		chainRules:  params.Rules{IsIstanbul: true, IsEIP150: true},
	}
	evm.interpreter = NewEVMInterpreter(evm, Config{NoBaseFee: true})
	_, contract, _, err := evm.Create(AccountRef(caller), common.FromHex(testSortCode), math.MaxUint64/2, big0)
	if err != nil {
		return nil, err
	}
	evm.chainConfig.ConsortiumV2Contracts = &params.ConsortiumV2Contracts{
		StakingContract:   contract,
		RoninValidatorSet: contract,
		SlashIndicator:    caller,
	}
	return evm, nil
}

func addressesToByte(addresses []common.Address) [][]byte {
	var result [][]byte
	for _, addr := range addresses {
		var value []byte
		for _, b := range addr.Bytes() {
			if b != 0 {
				value = append(value, b)
			}
		}
		result = append(result, value)
	}

	return result
}
