package vm

import (
	"math/big"
	"math/rand"
	"strings"
	"testing"

	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/rawdb"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/crypto"
	"github.com/ethereum/go-ethereum/params"
)

type testSuite struct {
	setupTransactions   []transaction // The transactions run before benchmark loop
	prepareTransactions []transaction // The transactions run before each loop iteration
	benchTransactions   []transaction // The actual transactions need to be benchmarked
	contracts           []contractCode
}

type contractCode struct {
	code    []byte
	address common.Address
}

type transaction struct {
	from     common.Address
	to       common.Address
	input    []byte
	gasLimit uint64
	value    *big.Int
}

func benchmarkEVM(b *testing.B, suite *testSuite) {
	statedb, err := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
	if err != nil {
		b.Fatal(err)
	}

	for _, contract := range suite.contracts {
		statedb.SetCode(contract.address, contract.code)
	}

	evm := NewEVM(
		BlockContext{
			BlockNumber:   common.Big0,
			Transfer:      func(_ StateDB, _, _ common.Address, _ *big.Int) {},
			PublishEvents: make(PublishEventsMap),
		},
		TxContext{},
		statedb,
		&params.ChainConfig{
			EIP150Block: common.Big0,
			EIP155Block: common.Big0,
			EIP158Block: common.Big0,
			LondonBlock: common.Big0,
		},
		Config{},
	)

	for _, tx := range suite.setupTransactions {
		_, _, err := evm.Call(AccountRef(tx.from), tx.to, tx.input, tx.gasLimit, tx.value)
		if err != nil {
			b.Fatal(err)
		}
	}

	hasPrepareTranction := len(suite.prepareTransactions) != 0
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		if hasPrepareTranction {
			b.StopTimer()
			for _, tx := range suite.prepareTransactions {
				_, _, err := evm.Call(AccountRef(tx.from), tx.to, tx.input, tx.gasLimit, tx.value)
				if err != nil {
					b.Fatal(err)
				}
			}
			b.StartTimer()
		}
		for _, tx := range suite.benchTransactions {
			_, _, err := evm.Call(AccountRef(tx.to), tx.to, tx.input, tx.gasLimit, tx.value)
			if err != nil {
				b.Fatal(err)
			}
		}
	}

}

func BenchmarkEvmInsertionSort(b *testing.B) {
	contractAbi, _ := abi.JSON(strings.NewReader(`[{"inputs": [{"internalType": "uint256[]","name": "a","type": "uint256[]"}],"name": "insertionSort","outputs": [],"stateMutability": "pure","type": "function"}]`))
	rand.New(rand.NewSource(0))
	const inputLen = 1_000
	input := make([]*big.Int, inputLen)
	for i := 0; i < inputLen; i++ {
		input[i] = big.NewInt(int64(rand.Int31()))
	}
	data, err := contractAbi.Pack("insertionSort", input)
	if err != nil {
		b.Fatal(err)
	}

	testAddress := common.BigToAddress(big.NewInt(0x204))
	suite := testSuite{
		benchTransactions: []transaction{
			{
				to:       testAddress,
				input:    data,
				gasLimit: 1_000_000_000,
				value:    common.Big0,
			},
		},
		contracts: []contractCode{
			{
				// https://github.com/Vectorized/solady/blob/678c9163550810b08f0ffb09624c9f7532392303/src/utils/LibSort.sol#L17
				code:    common.Hex2Bytes("608060405234801561001057600080fd5b506004361061002b5760003560e01c80636297206f14610030575b600080fd5b61004a60048036038101906100459190610264565b61004c565b005b8051600082528060051b82016020601f198185015b6001156100b65782810190508381116100b6578051828201805182811161008a575050506100b1565b5b6001156100a857808683015284820191508151905082811161008b575b82868301525050505b610061565b508385525050505050565b6000604051905090565b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b610123826100da565b810181811067ffffffffffffffff82111715610142576101416100eb565b5b80604052505050565b60006101556100c1565b9050610161828261011a565b919050565b600067ffffffffffffffff821115610181576101806100eb565b5b602082029050602081019050919050565b600080fd5b6000819050919050565b6101aa81610197565b81146101b557600080fd5b50565b6000813590506101c7816101a1565b92915050565b60006101e06101db84610166565b61014b565b9050808382526020820190506020840283018581111561020357610202610192565b5b835b8181101561022c578061021888826101b8565b845260208401935050602081019050610205565b5050509392505050565b600082601f83011261024b5761024a6100d5565b5b813561025b8482602086016101cd565b91505092915050565b60006020828403121561027a576102796100cb565b5b600082013567ffffffffffffffff811115610298576102976100d0565b5b6102a484828501610236565b9150509291505056fea2646970667358221220c05eb12b713fde4b945bd660ddeda4dc91b0d11b4749c8bf02617b25bf3c022064736f6c63430008120033"),
				address: testAddress,
			},
		},
	}

	benchmarkEVM(b, &suite)
}

func BenchmarkEvmQuickSort(b *testing.B) {
	contractAbi, _ := abi.JSON(strings.NewReader(`[{"inputs": [{"internalType": "uint256[]","name": "a","type": "uint256[]"}],"name": "sort","outputs": [],"stateMutability": "pure","type": "function"}]`))
	rand.New(rand.NewSource(0))
	const inputLen = 1_000
	input := make([]*big.Int, inputLen)
	for i := 0; i < inputLen; i++ {
		input[i] = big.NewInt(int64(rand.Int31()))
	}
	data, err := contractAbi.Pack("sort", input)
	if err != nil {
		b.Fatal(err)
	}

	testAddress := common.BigToAddress(big.NewInt(0x204))
	suite := testSuite{
		benchTransactions: []transaction{
			{
				to:       testAddress,
				input:    data,
				gasLimit: 1_000_000_000,
				value:    common.Big0,
			},
		},
		contracts: []contractCode{
			{
				// https://github.com/Vectorized/solady/blob/3e8031b16417154dc2beae71b7b45f415d29566b/src/utils/LibSort.sol#L65
				code:    common.Hex2Bytes("608060405234801561001057600080fd5b506004361061002b5760003560e01c80639ec8b02614610030575b600080fd5b61004a60048036038101906100459190610442565b61004c565b005b601f196020825160008452604051600282106100fd578285018260051b8601815b858101518151118282141761008657858101905061006d565b818103610095575050506100fd565b8190505b868101518151116100ae578681019050610099565b8281036100eb575b6001156100e357825182518452808352878301925086840193508284106100dd57506100e3565b506100b6565b5050506100fd565b82845281868501526040840193505050505b6040515b808214610294576040820391508151848301516101808282031161019457858201805183511061013657805183518252808452505b5b60011561018c57868101905081811161018c578051888201805182811161016057505050610187565b5b60011561017e57808a8301528a8201915081519050828111610161575b828a8301525050505b610137565b50505061028f565b81601f1681830160061c60051b016101b7565b6000808291508390509250929050565b825182518082106101d1576101cc81836101a7565b925090505b82518181106101e9576101e481836101a7565b925090505b8083106101ff576101fa81846101a7565b935090505b8084528185528286525050508051829150835b600115610266575b60011561022f5788810190508051821161021a575b825b600115610246578a8101905080518310610231575b8093508382106102565750610266565b8151845183528085525050610212565b50508681018552818782011060061b85019450828552808786015282811160061b850194505050505b610101565b508185525050505050565b6000604051905090565b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b610301826102b8565b810181811067ffffffffffffffff821117156103205761031f6102c9565b5b80604052505050565b600061033361029f565b905061033f82826102f8565b919050565b600067ffffffffffffffff82111561035f5761035e6102c9565b5b602082029050602081019050919050565b600080fd5b6000819050919050565b61038881610375565b811461039357600080fd5b50565b6000813590506103a58161037f565b92915050565b60006103be6103b984610344565b610329565b905080838252602082019050602084028301858111156103e1576103e0610370565b5b835b8181101561040a57806103f68882610396565b8452602084019350506020810190506103e3565b5050509392505050565b600082601f830112610429576104286102b3565b5b81356104398482602086016103ab565b91505092915050565b600060208284031215610458576104576102a9565b5b600082013567ffffffffffffffff811115610476576104756102ae565b5b61048284828501610414565b9150509291505056fea2646970667358221220f590ee27c624ceeb98c00b65f4e010837293405c27f985f82dbe000f5d583f7764736f6c63430008120033"),
				address: testAddress,
			},
		},
	}

	benchmarkEVM(b, &suite)
}

func BenchmarkEvmSignatureValidation(b *testing.B) {
	contractAbi, _ := abi.JSON(strings.NewReader(`[{"inputs": [{"internalType": "address","name": "signer","type": "address"},{"internalType": "bytes32","name": "hash","type": "bytes32"},{"internalType": "bytes","name": "signature","type": "bytes"}],"name": "isValidSignatureNowCalldata","outputs": [{"internalType": "bool","name": "isValid","type": "bool"}],"stateMutability": "view","type": "function"}]`))
	key, _ := crypto.GenerateKey()
	hash := crypto.Keccak256Hash([]byte("AAAAA"))
	signature, err := crypto.Sign(hash[:], key)
	if err != nil {
		b.Fatal(err)
	}

	data, err := contractAbi.Pack("isValidSignatureNowCalldata", crypto.PubkeyToAddress(key.PublicKey), hash, signature)
	if err != nil {
		b.Fatal(err)
	}

	testAddress := common.BigToAddress(big.NewInt(0x204))
	suite := testSuite{
		benchTransactions: []transaction{
			{
				to:       testAddress,
				input:    data,
				gasLimit: 1_000_000_000,
				value:    common.Big0,
			},
		},
		contracts: []contractCode{
			{
				// https://github.com/Vectorized/solady/blob/3e8031b16417154dc2beae71b7b45f415d29566b/src/utils/SignatureCheckerLib.sol#L120
				code:    common.Hex2Bytes("608060405234801561001057600080fd5b506004361061002b5760003560e01c806340a35e2e14610030575b600080fd5b61004a60048036038101906100459190610263565b610060565b60405161005791906102f2565b60405180910390f35b60008460601b60601c945084156101585760405184600052604083036100cd576020840135601b8160ff1c0160205284356040528060011b60011c606052602060016080600060015afa805188183d15176100ca5760019350600060605282604052505050610158565b50505b6041830361011357604084013560001a602052604084604037602060016080600060015afa805187183d151761011157600192506000606052816040525050610158565b505b600060605280604052631626ba7e60e01b80825285600483015260248201604081528460448401528486606485013760208160648701858b5afa828251141693505050505b949350505050565b600080fd5b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006101958261016a565b9050919050565b6101a58161018a565b81146101b057600080fd5b50565b6000813590506101c28161019c565b92915050565b6000819050919050565b6101db816101c8565b81146101e657600080fd5b50565b6000813590506101f8816101d2565b92915050565b600080fd5b600080fd5b600080fd5b60008083601f840112610223576102226101fe565b5b8235905067ffffffffffffffff8111156102405761023f610203565b5b60208301915083600182028301111561025c5761025b610208565b5b9250929050565b6000806000806060858703121561027d5761027c610160565b5b600061028b878288016101b3565b945050602061029c878288016101e9565b935050604085013567ffffffffffffffff8111156102bd576102bc610165565b5b6102c98782880161020d565b925092505092959194509250565b60008115159050919050565b6102ec816102d7565b82525050565b600060208201905061030760008301846102e3565b9291505056fea2646970667358221220e7aef4256acfe8a66e69b3302343656c8356cc59568106cad36b4994886104ec64736f6c63430008120033"),
				address: testAddress,
			},
		},
	}

	benchmarkEVM(b, &suite)
}
